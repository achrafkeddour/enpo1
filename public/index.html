<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat {
            display: flex;
            height: 80vh;
        }
        #userList {
            /* flex: 1; */
            border-right: 1px solid #ccc;
            overflow-y: auto;
            max-width: 45%;
        }
        #conversations {
            flex: 2;
            padding-left: 15px;
            overflow-y: auto;
        }
        .conversation {
            display: none;
        }
        .conversation.active {
            display: block;
        }
        .messages {
            height: 60vh;
            overflow-y: auto;
        }
        .progress {
            display: none;
            height: 20px;
        }

        /* CSS for screens smaller than 800px */
@media screen and (max-width: 800px) {
    #conversations {
        position: absolute;
        top: 50vh;
        z-index: 4;
        width: 60vw;
        height: 40vh;
        right: 10px;
       /* Hide the menu on smaller screens */
    }
  }
  
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card mt-5">
                    <div class="card-header">Private Chat</div>
                    <div class="card-body">
                        <div id="usernameInput" class="form-group">
                            <input id="username" class="form-control" placeholder="Enter your username" />
                            <button class="btn btn-primary mt-2" onclick="joinChat()">Join Chat</button>
                        </div>
                        <div id="chat" style="display:none;">
                            <div id="userList" class="list-group">
                                <!-- Users will be listed here -->
                            </div>
                            
                            <div id="conversations">
                                <!-- Conversations will be listed here -->
                            </div>
                            <form id="form" action="" class="mt-3">
                                <div class="form-group">
                                    <input id="recipient" autocomplete="off" class="form-control" placeholder="Recipient" />
                                    <textarea id="message" autocomplete="off" class="form-control mt-2" placeholder="Type a message..." rows="3"></textarea>
                                    <input type="file" id="image" class="form-control mt-2" />
                                </div>
                                <button class="btn btn-primary">Send</button>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        var socket = io();

        function joinChat() {
            var username = $('#username').val();
            if (username) {
                socket.emit('join', username);
                $('#usernameInput').hide();
                $('#chat').show();
            }
        }

        function switchConversation(recipient) {
            $('.conversation').removeClass('active');
            if (!$(`#conversation-${recipient}`).length) {
                $('#conversations').append(`
                    <div class="conversation" id="conversation-${recipient}">
                        <h5>Conversation with ${recipient}</h5>
                        <ul class="messages list-unstyled"></ul>
                    </div>
                `);
            }
            $(`#conversation-${recipient}`).addClass('active');
            $('#recipient').val(recipient);
        }

        $(function () {
            $('form').submit(function(event) {
                event.preventDefault();
                var recipient = $('#recipient').val();
                var message = $('#message').val();
                var fileInput = $('#image')[0];
                var progress = $('.progress');

                if (recipient && (message || fileInput.files.length)) {
                    if (fileInput.files.length > 0) {
                        var formData = new FormData();
                        formData.append('image', fileInput.files[0]);

                        progress.show();

                        $.ajax({
                            url: '/upload',
                            type: 'POST',
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: function(data) {
                                const timestamp = new Date().getTime();
                                socket.emit('private message', { recipient, message, imageUrl: `${data.imageUrl}?t=${timestamp}` });
                                $(`#conversation-${recipient} .messages`).append($('<li>').html('To ' + recipient + ': ' + message + '<br><img src="' + data.imageUrl + '?t=' + timestamp + '" class="img-fluid" />'));
                                $('#message').val('');
                                $('#image').val('');
                                progress.hide();
                            },
                            error: function(err) {
                                alert('Error uploading file.');
                                progress.hide();
                            }
                        });
                    } else {
                        socket.emit('private message', { recipient, message, imageUrl: '' });
                        $(`#conversation-${recipient} .messages`).append($('<li>').text('To ' + recipient + ': ' + message));
                        $('#message').val('');
                    }
                }
            });

            socket.on('private message', function({ sender, message, imageUrl }) {
                if (!$(`#conversation-${sender}`).length) {
                    $('#conversations').append(`
                        <div class="conversation" id="conversation-${sender}">
                            <h5>Conversation with ${sender}</h5>
                            <ul class="messages list-unstyled"></ul>
                        </div>
                    `);
                }
                var messageContent = 'From ' + sender + ': ' + message;
                if (imageUrl) {
                    messageContent += '<br><img src="' + imageUrl + '" class="img-fluid" />';
                }
                $(`#conversation-${sender} .messages`).append($('<li>').html(messageContent));
            });

            socket.on('updateUserList', function(users) {
                $('#userList').empty();
                users.forEach(function(user) {
                    $('#userList').append($('<button class="list-group-item list-group-item-action">').text(user).click(function() {
                        switchConversation(user);
                    }));
                });
            });
        });
    </script>
</body>
</html>
